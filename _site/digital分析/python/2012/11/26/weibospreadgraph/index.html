
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="ujianVerification" content="fbba4ee9b28ec33f11f17698ddc55b92" />
    <link rel="stylesheet" href="/pygments.css">
    <title>新浪微博传播路径图的制作</title>
    
    <meta name="author" content="Cloga Chen">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/assets/themes/bootstrap/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  
    <!--[if lt IE 9]>
      <script src="/assets/themes/bootstrap/resources/respond/Respond.min.js"></script>
    <![endif]-->

    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    <script>
      dataLayer = [];
    </script>
  </head>

  <body>
    <nav class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Cloga的互联网笔记</a>
        </div>

        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          <li><a href="/about.html">关于Cloga</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      
<div class="page-header">
  <h1>新浪微博传播路径图的制作 </h1>
</div>
<div class="row post-full">
  <div class="col-md-12">
    <div class="date">
      <span>26 November 2012</span>
    </div>
    <div class="content">
      <p>[caption id=&quot;attachment_1726&quot; align=&quot;aligncenter&quot; width=&quot;614&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/Untitled.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/Untitled.png" alt="微博传播图"></a> 微博传播图[/caption]</p>

<p>经常在微博上看到微博传播路径图。其实只要会一点Python、GVEdit和Gephi，你也可以自己动手制作新浪微博的传播路径图。这篇文章就和大家讲讲如何制作这类传播路径图。下面的内容会涉及到新浪API，Python，GVEdit，Gephi这些工具或知识。</p>

<h3><strong>通过Python调用新浪API</strong></h3>

<p>在<a href="http://open.weibo.com/">新浪微博开放平台</a>注册账号，创建应用。</p>

<p>[caption id=&quot;attachment_1723&quot; align=&quot;aligncenter&quot; width=&quot;425&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/11.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/11.png" alt="创建应用"></a> 创建应用[/caption]</p>

<p>&lt;!-- more --&gt;创建其他应用，客户端-桌面。一个账号可以创建10个应用，建议同时创建10个应用，因为新创建的应用是测试权限，每个应用每个用户每小时只有150次的调用次数，10个应用就可以1500次调用，为什么要保证最大调用次数，我会在后面的内容里讲。</p>

<p>创建完成后，点击管理应用进入创建的应用中，应用信息&gt;高级信息，添加其中的OAuth2.0 授权设置的回调页面，这个地址可以随便填写，但是不能空着，后面需要用到。</p>

<p>我们来看一下新浪API的OAuth流程（即给一个应用授权的过程）。</p>

<p>[caption id=&quot;attachment<em>1725&quot; align=&quot;aligncenter&quot; width=&quot;620&quot;][<img src="http://www.cloga.info/wp-content/uploads/2012/11/oAuth2_02.gif" alt="oAuth2_02">](http://www.cloga.info/wp-content/uploads/2012/11/oAuth2</em>02.gif) oAuth2_02[/caption]</p>

<ol>
<li>引导需要授权的用户到如下地址：</li>
</ol>
<div class="highlight"><pre><code class="language-html" data-lang="html">https://api.weibo.com/oauth2/authorize?client_id=YOUR_CLIENT_ID<span class="err">&amp;</span>response_type=code<span class="err">&amp;</span>redirect_uri=YOUR_REGISTERED_REDIRECT_URI
</code></pre></div>
<ol>
<li>如果用户同意授权,页面跳转至 YOUR<em>REGISTERED</em>REDIRECT_URI/?code=CODE</li>
<li>换取Access Token</li>
</ol>
<div class="highlight"><pre><code class="language-html" data-lang="html">https://api.weibo.com/oauth2/access_token?client_id=YOUR_CLIENT_ID<span class="err">&amp;</span>client_secret=YOUR_CLIENT_SECRET<span class="err">&amp;</span>grant_type=authorization_code<span class="err">&amp;</span>redirect_uri=YOUR_REGISTERED_REDIRECT_URI<span class="err">&amp;</span>code=CODE
</code></pre></div>
<p>（其中client<em>id=YOUR</em>CLIENT<em>ID&amp;client</em>secret=YOUR<em>CLIENT</em>SECRET可以使用basic方式加入header中）
返回值</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&quot;access_token&quot;</span><span class="p">:</span><span class="s2">&quot;SlAV32hkKG&quot;</span><span class="p">,</span> <span class="nt">&quot;remind_in &quot;</span><span class="p">:</span><span class="mi">3600</span><span class="p">,</span> <span class="nt">&quot;expires_in&quot;</span><span class="p">:</span><span class="mi">3600</span> <span class="p">}</span>
</code></pre></div>
<ol>
<li>使用获得的OAuth2.0 Access Token调用API</li>
</ol>

<p>其中client<em>id和client</em>secret对应的是应用基本信息中的App<em>key和App</em>secret。redirect_url就是授权回调页的URL，如果URL没有填写调用时会报错。</p>

<p>这个流程简单来说就是向新浪的认证服务器发出认证请求（1），新浪会在这个认证页面让用户填写用户名、密码，如果用户同意认证，新浪微博就会把用户重定向到填入的回调URL，URL参数中带有code这个参数（2），然后用这个code和App<em>key,App</em>secret这些信息请求新浪的认证服务器就可以获得token（3）。获得了token之后，在url参数中携带这个参数就可以调用API。</p>

<p>这个流程是不是听起来很复杂，不知道如何下手？不过不用担心，廖雪峰同学提供了<a href="http://michaelliao.github.com/sinaweibopy/">新浪微博AP</a><a href="http://michaelliao.github.com/sinaweibopy/">I</a><a href="http://michaelliao.github.com/sinaweibopy/">Python版SDK</a>，可以帮我们简化这个过程，同时我在另外的一个文章中看到了如何获得code参数（链接找不到），这样，其实我们只需要一个Python函数就能完成认证流程，不需要再手动登陆认证。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">access_client</span><span class="p">(</span><span class="n">app_index</span><span class="p">):</span>
    <span class="n">APP_KEY</span><span class="o">=</span> <span class="n">APP_KEYS_SECRETS</span><span class="p">[</span><span class="n">app_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c">#app key</span>
    <span class="n">APP_SECRET</span> <span class="o">=</span> <span class="n">APP_KEYS_SECRETS</span><span class="p">[</span><span class="n">app_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c"># app secret</span>
    <span class="n">CALLBACK_URL</span> <span class="o">=</span> <span class="s">&#39;http://www.cloga.info&#39;</span> <span class="c"># callback url</span>
    <span class="n">username</span><span class="o">=</span><span class="s">&#39;XXXXX&#39;</span>
    <span class="n">password</span><span class="o">=</span><span class="s">&#39;YYYYY&#39;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">app_key</span><span class="o">=</span><span class="n">APP_KEY</span><span class="p">,</span> <span class="n">app_secret</span><span class="o">=</span><span class="n">APP_SECRET</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="o">=</span><span class="n">CALLBACK_URL</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_authorize_url</span><span class="p">()</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="p">(</span><span class="s">&#39;api.weibo.com&#39;</span><span class="p">)</span>
    <span class="n">postdata</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s">&#39;client_id&#39;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span><span class="s">&#39;response_type&#39;</span><span class="p">:</span><span class="s">&#39;code&#39;</span><span class="p">,</span><span class="s">&#39;redirect_uri&#39;</span><span class="p">:</span><span class="n">CALLBACK_URL</span><span class="p">,</span><span class="s">&#39;action&#39;</span><span class="p">:</span><span class="s">&#39;submit&#39;</span><span class="p">,</span><span class="s">&#39;userId&#39;</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">&#39;passwd&#39;</span><span class="p">:</span><span class="n">password</span><span class="p">,</span><span class="s">&#39;isLoginSina&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;from&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;regCallback&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;state&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;ticket&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;withOfficalFlag&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="s">&#39;/oauth2/authorize&#39;</span><span class="p">,</span><span class="n">postdata</span><span class="p">,{</span><span class="s">&#39;Referer&#39;</span><span class="p">:</span><span class="n">url</span><span class="p">,</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">})</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span><span class="c">##拿新浪给的code</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">msg</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">query</span><span class="p">)[</span><span class="s">&#39;code&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">request_access_token</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">access_token</span> <span class="c"># 新浪返回的token，类似abc123xyz456</span>
    <span class="n">expires_in</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">expires_in</span> <span class="c"># token过期的UNIX时间：http://zh.wikipedia.org/wiki/UNIX%E6%97%B6%E9%97%B4</span>
    <span class="c"># TODO: 在此可保存access token</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set_access_token</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">expires_in</span><span class="p">)</span><span class="c">##生成token</span>
    <span class="k">return</span> <span class="n">client</span>
</code></pre></div>
<p>这个函数的参数是app<em>index，这个参数是用来获得app</em>key和app_secret，前面已经提到，新浪对测试版的app的调用限制为单用户一个小时150次请求，这个请求数对于转发数比较多的帖子是远远不够的，所以我将申请的10个App放在一个列表中，每次一个app的quota不足，则自动切换到下一个app。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python">    <span class="c">#定义供替换的APP Key和Secret</span>
    <span class="n">APP_KEYS_SECRETS</span><span class="o">=</span><span class="p">[[</span><span class="s">&#39;KKKKK&#39;</span><span class="p">,</span><span class="s">&#39;SSSSS&#39;</span><span class="p">],</span>\
                      <span class="p">[</span><span class="s">&#39;KKKKK&#39;</span><span class="p">,</span><span class="s">&#39;SSSSS&#39;</span><span class="p">],</span>\
                      <span class="p">]</span>

    <span class="c">##随机取出一个app index</span>
    <span class="n">current_index</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">APP_KEYS_SECRETS</span><span class="p">))</span>
</code></pre></div>
<p>这样，通过client=access<em>client(current</em>index)就能获得token。</p>

<p>通过client.statuses.repost_timeline.get(id=id,count=count,page=page)就能获得获取指定微博的转发微博列表，新浪的官方说明见：<a href="http://open.weibo.com/wiki/2/statuses/repost_timeline">statuses/repost_timeline</a></p>

<p>以这个api为例说明Python SDK的API的调用规则：将&quot;/&quot;替换为&quot;.&quot;，如果是get方法就在后面使用get。</p>

<p>client.statuses.repost<em>timeline.get(id=XXXX,count=200,page=1)就获得了id为XXXX的微博的第一页的2oo个转发的信息。由于新浪返回的是一个json对象。我们可以用类似字典的方式来处理这些数据，比如reposts=client.statuses.repost</em>timeline.get(id=XXXX,count=200,page=1)，reposts[&#39;reposts&#39;]就获得了一个列表，这个列表的每个成员是一个转发的信息所构成的字典。</p>

<p>id就是指定的微博id，count是指一页显示的结果数，page是页数。由于目前新浪微博API的Cursor和Max_id都不好用，因此，要获得一条微博的所有reposts只能通过翻页获得。</p>

<p>这样我们通过repost<em>timeline返回的‘total</em>number’就能知道这条微博一共有多少转发，将这个转发除以200，取ceil就获得共需翻页的次数，通过循环就可以获得所有的转发。</p>

<p>刚才提到，新浪微博API的调用每个小时都有限制，如果一个app<em>key quota不足我们就应该用另一个去重新认证。因此，我把client.statuses.repost</em>timeline.get和client.statuses.show.get的外面包了一层，加了个try，except，因为quota不足会抛异常出来，因此只要捕捉到这个异常，就重新授权，保证程序的连贯性（不过转发太多的帖子依然会超，这个没办法，只能申请更高的权限）。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_repost_timeline</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">page</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">max_id</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">repost_timeline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span><span class="n">max_id</span><span class="o">=</span><span class="n">max_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
    <span class="k">global</span> <span class="n">client</span>
    <span class="k">global</span> <span class="n">current_index</span>
    <span class="k">global</span> <span class="n">next_index</span>
    <span class="k">print</span> <span class="s">&#39;current_index&#39;</span><span class="p">,</span><span class="n">current_index</span>
    <span class="n">next_index</span><span class="o">=</span><span class="n">get_app_index</span><span class="p">(</span><span class="n">current_index</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;next_index&#39;</span><span class="p">,</span><span class="n">next_index</span>
    <span class="n">client</span><span class="o">=</span><span class="n">access_client</span><span class="p">(</span><span class="n">next_index</span><span class="p">)</span>
    <span class="n">current_index</span><span class="o">=</span><span class="n">next_index</span>
    <span class="k">return</span> <span class="n">get_repost_timeline</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span><span class="n">max_id</span><span class="o">=</span><span class="n">max_id</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_show</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">show</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
        <span class="k">global</span> <span class="n">client</span>
        <span class="k">global</span> <span class="n">current_index</span>
        <span class="k">global</span> <span class="n">next_index</span>
        <span class="k">print</span> <span class="s">&#39;current_index&#39;</span><span class="p">,</span><span class="n">current_index</span>
        <span class="n">next_index</span><span class="o">=</span><span class="n">get_app_index</span><span class="p">(</span><span class="n">current_index</span><span class="p">)</span>
        <span class="n">client</span><span class="o">=</span><span class="n">access_client</span><span class="p">(</span><span class="n">next_index</span><span class="p">)</span>
        <span class="n">current_index</span><span class="o">=</span><span class="n">next_index</span>
        <span class="k">print</span> <span class="s">&#39;next_index&#39;</span><span class="p">,</span><span class="n">next_index</span>
        <span class="k">return</span> <span class="n">get_show</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
</code></pre></div>
<p>这里有一点要说明的是，由于采用翻页的方式以及新浪api返回数据的限制（有的微博转发被大量的删除，这部分数据会被过滤掉），这种方式实际获得的转发数可能与页面上看到的不同。</p>

<h3><strong>生成DOT文件</strong></h3>

<p>前面介绍了新浪微博API Python SDK调用方式。接下来就用Python生成我们需要的数据。</p>

<p>我们需要的是传播路径图，我使用的是<a href="http://www.graphviz.org/">GVEdit</a>的DOT语言生成图片（几百个节点GVedit可以支持，如果节点量比较大，windows下就崩溃，不知道什么原因，不过我们可以用Gephi代替）。下面是DOT语言的样例：</p>

<p>&quot;joeghwu&quot; -&gt; &quot;刘<em>黑七&quot; [weibo</em>id=3506825367989409];</p>

<p>&quot;崔科增&quot; -&gt; &quot;琴瑟樵夫&quot; [weibo_id=3506945706899086];</p>

<p>&quot;琴瑟樵夫&quot; -&gt; &quot;崔科增&quot; [weibo_id=3506944666865337];</p>

<p>可以看到每个DOT文件就是描述一个边（Edge）。形式为起点-&gt;终点 标签，每个边的数据就是信息在两个人之间的传播方向。</p>

<p>2013-5-20更新：新浪微博的转发中有一个pid参数，这个参数就是一个微博的上一个微博id，通过这个id就不需要递归获得传播方向。</p>

<p>这里要说明的是，新浪微博的转发接口中提供的是所有转发，不仅仅是第一层的转发，即如果A发了一个微博，B转发这条微博，C转发B的这条微博，则通过新浪的转发接口获取A的转发也会获得C转发的那条微博，只是不知道信息的流动顺序。</p>

<p>如果要获得这种传播的层次关系，一种方式就是定义一个函数进行递归，根据转发微博的发出者与被转发微博的发出者确定传播方向，第一次运行时，认为所有的转发都是原始微博的第一次传播（其实其中可能包含多次的传播），即认为每个边都是由被转发微博的发出者到转发微博的发出者，然后进行递归，第二次将所有带有转发的微博作为参数传给这个函数，同样的逻辑，认为所有的转发都是这些带有转发的微博进一步传播。</p>

<p>举一个最简单的例子来说明一下这个过程：</p>

<p>真实的传播路径：</p>

<p>用户A发出微博a</p>

<p>用户B转发了微博a，发出微博b，b：A&gt;B</p>

<p>用户C转发了微博b，发出微博c，c：B&gt;C</p>

<p>获得真实传播路径的过程：</p>

<p>第一次：传给新浪a(发出者是A)，新浪返回a的转发b(发出者为B)和c(发出者为C)，这时b：A&gt;B，c：A&gt;C</p>

<p>第二次：发现b有转发，把b(发出者为B)传给新浪，新浪返回b的转发c(发出者为C)，这时c：B&gt;C</p>

<p>下面是代码样例：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_edges</span><span class="p">(</span><span class="n">post_id</span><span class="p">,</span><span class="n">edeges</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">total_number</span><span class="o">=</span><span class="n">get_repost_timeline</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">200</span><span class="p">)[</span><span class="s">&#39;total_number&#39;</span><span class="p">]</span>
<span class="c">##    print &#39;Total Number:&#39;,total_number</span>
    <span class="n">reposts</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">page_reposts</span><span class="o">=</span><span class="n">get_repost_timeline</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">200</span><span class="p">)[</span><span class="s">&#39;reposts&#39;</span><span class="p">]</span>
    <span class="n">reposts</span><span class="o">+=</span><span class="n">page_reposts</span>
    <span class="n">page_number</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_number</span><span class="o">/</span><span class="mi">200</span><span class="p">))</span>
<span class="c">##    print &#39;Total Page Number:&#39;,page_number</span>
    <span class="k">if</span> <span class="n">page_number</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">page_number</span><span class="p">):</span>
<span class="c">##            print &#39;page_number:&#39;,i</span>
            <span class="n">reposts</span><span class="o">+=</span><span class="n">get_repost_timeline</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">page</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)[</span><span class="s">&#39;reposts&#39;</span><span class="p">]</span>
    <span class="n">reposts</span><span class="o">=</span><span class="p">[</span><span class="n">repost</span> <span class="k">for</span> <span class="n">repost</span> <span class="ow">in</span> <span class="n">reposts</span> <span class="k">if</span> <span class="n">repost</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;reposts_count&#39;</span><span class="p">)]</span><span class="c">##有些微博是删除的</span>
<span class="c">##    print &#39;Total Reposts:&#39;,len(reposts)</span>
    <span class="n">reposted</span><span class="o">=</span><span class="n">get_show</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">)[</span><span class="s">&#39;user&#39;</span><span class="p">][</span><span class="s">&#39;screen_name&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">reposted</span><span class="o">==</span><span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">reposted</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">get_show</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">)[</span><span class="s">&#39;user&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">])</span><span class="c">##存在Screen_name为空的情况</span>
    <span class="k">for</span> <span class="n">repost</span> <span class="ow">in</span> <span class="n">reposts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">repost</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">][</span><span class="s">&#39;screen_name&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]]</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;poster&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]),</span><span class="s">&#39;reposted&#39;</span><span class="p">:</span><span class="n">reposted</span><span class="p">,</span><span class="s">&#39;content&#39;</span><span class="p">:</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">],</span><span class="s">&#39;created_at&#39;</span><span class="p">:</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;created_at&#39;</span><span class="p">],</span><span class="s">&#39;reposts&#39;</span><span class="p">:</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;reposts_count&#39;</span><span class="p">],</span><span class="s">&#39;comments&#39;</span><span class="p">:</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;comments_count&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]]</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;poster&#39;</span><span class="p">:</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">][</span><span class="s">&#39;screen_name&#39;</span><span class="p">],</span><span class="s">&#39;reposted&#39;</span><span class="p">:</span><span class="n">reposted</span><span class="p">,</span><span class="s">&#39;content&#39;</span><span class="p">:</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">],</span><span class="s">&#39;created_at&#39;</span><span class="p">:</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;created_at&#39;</span><span class="p">],</span><span class="s">&#39;reposts&#39;</span><span class="p">:</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;reposts_count&#39;</span><span class="p">],</span><span class="s">&#39;comments&#39;</span><span class="p">:</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;comments_count&#39;</span><span class="p">]}</span><span class="c">##存在Screen_name为空的情况</span>
    <span class="n">reposts</span><span class="o">=</span><span class="p">[</span><span class="n">repost</span> <span class="k">for</span> <span class="n">repost</span> <span class="ow">in</span> <span class="n">reposts</span> <span class="k">if</span> <span class="n">repost</span><span class="p">[</span><span class="s">&#39;reposts_count&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">repost</span> <span class="ow">in</span> <span class="n">reposts</span><span class="p">:</span>
        <span class="n">get_edges</span><span class="p">(</span><span class="n">repost</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">edges</span>
</code></pre></div>
<p>这样就将每一条微博转化为了一个边，其实是edges的一个Item，key是微博的ID，Value是个字典，其中的成员依次是转发的用户名，被转发的用户名，转发微博的内容，微博发布的事件，转发数，评论数。</p>

<p>有了这个函数，使用edges=get<em>edges(post</em>id)这个函数就可以将指定的微博转化为边。</p>

<p>接下来，将edges输出为.dot文件。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">generate_dot</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="n">OUT</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">+</span><span class="s">&quot;.dot&quot;</span>
    <span class="n">dot</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; -&gt; &quot;</span><span class="si">%s</span><span class="s">&quot; [weibo_id=</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">edges</span><span class="p">[</span><span class="n">weibo_id</span><span class="p">][</span><span class="s">&#39;reposted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;gbk&#39;</span><span class="p">,</span><span class="s">&#39;ignore&#39;</span><span class="p">),</span><span class="n">edges</span><span class="p">[</span><span class="n">weibo_id</span><span class="p">][</span><span class="s">&#39;poster&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;gbk&#39;</span><span class="p">,</span><span class="s">&#39;ignore&#39;</span><span class="p">),</span> <span class="n">weibo_id</span><span class="p">)</span><span class="k">for</span> <span class="n">weibo_id</span> <span class="ow">in</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">OUT</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;strict digraph {</span><span class="se">\n</span><span class="s">node [fontname=&quot;FangSong&quot;]</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dot</span><span class="p">),))</span>
        <span class="k">print</span> <span class="s">&#39;dot file export&#39;</span>
</code></pre></div>
<p>strict digraph是用来指定图形的类型为有向图，[fontname=&quot;FangSong&quot;]则是指定中文的仿宋字体，不然会是乱码。</p>

<h3><strong>生成微博传播路径图</strong></h3>

<p>有了DOT文件，只要将DOT文件导入<a href="http://www.graphviz.org/">GVEdit</a>生成circo类型的图片即可。下载安装<a href="http://www.graphviz.org/Download_windows.php">graphviz的windows stable版本</a>就能获得GVEdit（Windows下的GVEdit有很多局限性，graphviz对应的Python包pygraphviz也不能用）。</p>

<p>打开GVEdit&gt;file&gt;open，打开刚才生成的DOT文件。点击Graph的setting。</p>

<p>[caption id=&quot;attachment_1730&quot; align=&quot;aligncenter&quot; width=&quot;412&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/444.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/444.png" alt="Graph Setting"></a> Graph Setting[/caption]</p>

<p>将Layout改成circo，默认是dot。将Output File Name设定为你要保存的路径(不支持中文路径)及文件名，点击保存，传播路径图就会被生成到对应的路径中。</p>

<p>[caption id=&quot;attachment_1731&quot; align=&quot;aligncenter&quot; width=&quot;300&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/555.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/555-300x127.png" alt="传播路径图"></a> 传播路径图[/caption]</p>

<p>此外，也可以用<a href="https://gephi.org/">Gephi</a>生成传播路径图，尤其是节点比较多的情况。</p>

<p>打开Gephi，文件&gt;打开，对应的DOT文件。</p>

<p>[caption id=&quot;attachment_1732&quot; align=&quot;aligncenter&quot; width=&quot;300&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/6666.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/6666-300x282.png" alt="初始状态"></a> 初始状态[/caption]</p>

<p>点击概览(Gephi支持中文，请使用中文版本)，右侧会显示上图的初始的状态。这是一个混乱的状态。流程选择Yifan Hu，点击运行。</p>

<p>[caption id=&quot;attachment_1733&quot; align=&quot;aligncenter&quot; width=&quot;279&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/777.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/777.png" alt="流程选择"></a> 流程选择[/caption]</p>

<p>Gephi会根据算法进行迭代计算，生成传播图。</p>

<p>[caption id=&quot;attachment_1734&quot; align=&quot;aligncenter&quot; width=&quot;300&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/888.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/888-300x292.png" alt="中间状态中间状态"></a> 中间状态[/caption]</p>

<p>上面是计算过程中的一个中间状态。</p>

<p>[caption id=&quot;attachment_1735&quot; align=&quot;aligncenter&quot; width=&quot;294&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/99999.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/99999-294x300.png" alt="最终状态"></a> 最终状态[/caption]</p>

<p>迭代完成后的最终状态可以明显的看到，这次传播有三个二次传播的中心。</p>

<p>要保存Gephi中的图形，点击预览，如果需要中文标签，则在节点标签中勾选显示标签，将字体设置为中文字体（比如，微软雅黑，黑体之类，不然会是乱码），点击刷新，每个节点就会显示对应的中文标签。在预设值这里还可以选择边的类型。点击左下角SVG/PDF/PNG就可以将图形保存下来。</p>

<p>以上就是制作新浪微博传播路径图的简单介绍，有兴趣的同学，可以自己动手尝试一下。如果遇到任何问题，欢迎给我留言。</p>

<p>最后，再给大家分享几个传播路径图。</p>

<p>[caption id=&quot;attachment_1737&quot; align=&quot;aligncenter&quot; width=&quot;300&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/1233.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/1233-300x289.png" alt="传播路径图001"></a> 传播路径图001[/caption]</p>

<p>[caption id=&quot;attachment_1738&quot; align=&quot;aligncenter&quot; width=&quot;300&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/22233.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/22233-300x261.png" alt="传播路径图002"></a> 传播路径图002[/caption]</p>

<p>[caption id=&quot;attachment_1739&quot; align=&quot;aligncenter&quot; width=&quot;300&quot;]<a href="http://www.cloga.info/wp-content/uploads/2012/11/33334.png"><img src="http://www.cloga.info/wp-content/uploads/2012/11/33334-300x242.png" alt="传播路径图003"></a> 传播路径图003[/caption]</p>

<p>动手制作属于你自己的传播图吧~</p>

    </div>

    
      <ul class="tag_box inline">
        <li><i class="icon-folder-open"></i></li>
        
        


  
     
    	<li><a href="/categories.html#digital分析-ref">
    		digital分析 <span>32</span>
    	</a></li>
     
    	<li><a href="/categories.html#python-ref">
    		python <span>17</span>
    	</a></li>
    
  


      </ul>
    

    
      <ul class="tag_box inline">
        <li><i class="icon-tags"></i></li>
        
        


  
     
    	<li><a href="/tags.html#gephi-ref">gephi <span>2</span></a></li>
     
    	<li><a href="/tags.html#gvedit-ref">gvedit <span>1</span></a></li>
     
    	<li><a href="/tags.html#Python-ref">Python <span>17</span></a></li>
     
    	<li><a href="/tags.html#social graph-ref">social graph <span>2</span></a></li>
    
  



      </ul>
    

    <hr>
    
    <ul class="pagination">
      
        <li class="prev"><a href="/digital%E5%88%86%E6%9E%90/2012/10/25/GTM&Tags" title="在GTM中指定Tag的依存关系">&larr; 上一页</a></li>
      
        <li><a href="/archive.html">归档列表</a></li>
      
        <li class="next"><a href="/sna/2012/12/24/gephipic" title="美化一下Gephi生成的微博传播图">下一页 &rarr;</a></li>
      
    </ul>
    <hr>
    <!-- Paste the 3 next lines where you want the sharing button(s) to appear -->
    <div class="post-sharing">
     


  <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
	<span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tools_1"></a>
	<a class="jiathis_button_tools_2"></a>
	<a class="jiathis_button_tools_3"></a>
	<a class="jiathis_button_tools_4"></a>
	<a href="http://www.jiathis.com/share?uid=1654363" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1343300786690926" charset="utf-8"></script>
<!-- JiaThis Button END -->



    </div>    
    <div class="post-comments">
    


  <!-- UJian Button BEGIN -->
<div class="ujian-hook"></div>
<script type="text/javascript">var ujian_config = {num:12,picSize:84,textHeight:45};</script>
<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?uid=1654363"></script>
<a href="http://www.ujian.cc" style="border:0;"><img src="http://img.ujian.cc/pixel.png" alt="友荐云推荐" style="border:0;padding:0;margin:0;" /></a>
<!-- UJian Button END -->
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1654363"></script>
<!-- UY END -->



    </div>
  </div>
</div>


      <hr>
      <footer>
        <p>
          &copy; 2014 Cloga Chen
          <span class="pull-right text-muted">
            powered by
            <a href="http://jekyll-bootstrap-3.github.io" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll-Bootstrap-3</a>
            and <a href="http://getbootstrap.com" target="_blank">Twitter Bootstrap 3.0.3</a>
          </span>
        </p>
      </footer>
    </div>

    
    <script src="/assets/themes/bootstrap/resources/jquery/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap/resources/bootstrap/js/bootstrap.min.js"></script>
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-7VF4"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-7VF4');</script>
<!-- End Google Tag Manager -->


  </body>
</html>

