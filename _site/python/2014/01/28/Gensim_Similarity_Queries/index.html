
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="ujianVerification" content="fbba4ee9b28ec33f11f17698ddc55b92" />
    <link rel="stylesheet" href="/pygments.css">
    <title>gensim文档-相似性查询</title>
    
    <meta name="author" content="Cloga Chen">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/assets/themes/bootstrap/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  
    <!--[if lt IE 9]>
      <script src="/assets/themes/bootstrap/resources/respond/Respond.min.js"></script>
    <![endif]-->

    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    <script>
      dataLayer = [];
    </script>
  </head>

  <body>
    <nav class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Cloga的互联网笔记</a>
        </div>

        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          <li><a href="/about.html">关于Cloga</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      
<div class="page-header">
  <h1>gensim文档-相似性查询 </h1>
</div>
<div class="row post-full">
  <div class="col-md-12">
    <div class="date">
      <span>28 January 2014</span>
    </div>
    <div class="content">
      <p>如果你想要查看logging事件不要忘记设置。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> : </span><span class="si">%(levelname)s</span><span class="s"> : </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</code></pre></div>
<h1>相似性接口</h1>

<p>在前面语料与向量空间的教程及主题和转换的教程中，我们涵盖了什么是在向量空间中创建一个语料库以及如何在不同的向量空间间转换。绕这样一个圈子的原因是我们想要判断一堆文档的相似性，或者特定文档与一组其他文档的相似性（比如用户查询 vs. 索引文档）。</p>

<p>为了展示gensim如何做到这一点，让我们看一下前面例子中语料（最初来自Deerwester等的<a href="http://www.cs.bham.ac.uk/%7Epxt/IDA/lsa_ind.pdf">“Indexing by Latent Semantic Analysis” seminal 1990 article</a>）:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">corpora</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">similarities</span>
<span class="n">dictionary</span> <span class="o">=</span> <span class="n">corpora</span><span class="o">.</span><span class="n">Dictionary</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;/tmp/deerwester.dict&#39;</span><span class="p">)</span>
<span class="n">corpus</span> <span class="o">=</span> <span class="n">corpora</span><span class="o">.</span><span class="n">MmCorpus</span><span class="p">(</span><span class="s">&#39;/tmp/deerwester.mm&#39;</span><span class="p">)</span> <span class="c"># 来自一篇教程“从字符到向量”</span>
<span class="k">print</span> <span class="n">corpus</span>

<span class="n">MmCorpus</span><span class="p">(</span><span class="mi">9</span> <span class="n">documents</span><span class="p">,</span> <span class="mi">12</span> <span class="n">features</span><span class="p">,</span> <span class="mi">28</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">entries</span><span class="p">)</span>
</code></pre></div>
<p>遵循Deerwester的例子，我们首先使用这个小样本语料定义一个二维的LSI空间：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">lsi</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LsiModel</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">id2word</span><span class="o">=</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">num_topics</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<p>现在假设用户输入查询“Human computer interaction”。我们会想要以与查询相似度降序排列我们的9个语料。与现代搜索引擎不同，这里我们只关注可能相似的一个方面-文档（词）的表面抑郁相关。没有超链接，静态排名的随机游走，只有在布尔关键词匹配的语义扩展：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;Human computer interaction&quot;</span>
<span class="n">vec_bow</span> <span class="o">=</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">vec_lsi</span> <span class="o">=</span> <span class="n">lsi</span><span class="p">[</span><span class="n">vec_bow</span><span class="p">]</span> <span class="c"># convert the query to LSI space</span>
<span class="k">print</span> <span class="n">vec_lsi</span>

<span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.461821</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.070028</span><span class="p">)]</span>
</code></pre></div>
<p>此外，我们将用余弦相似性来决定两个向量间的相似性。余弦相似性是向量空间模型中的标准度量，但是，当向量代表概率分布时，不同的相似性度量可能更适合。</p>

<h1>初始化查询结构</h1>

<p>要准备相似性查询，我们需要输入所有想要与随后的查询比较的所有文档。在这种情况下，还是用于训练LSI的9个文档被转化为二维空间。但是，这只是偶然，我们也可能索引不同的的语料。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">index</span> <span class="o">=</span> <span class="n">similarities</span><span class="o">.</span><span class="n">MatrixSimilarity</span><span class="p">(</span><span class="n">lsi</span><span class="p">[</span><span class="n">corpus</span><span class="p">])</span> <span class="c"># 将语料转换为LSI，并索引</span>
</code></pre></div>
<h2>警告</h2>

<p>similarities.MatrixSimilarity这个类只适用于所有语料可以放入内存的情况。例如，使用这个类，256维的LSI空间中的100万文档会需要2G的内存。</p>

<p>如果没有2G的可用内存，你需要使用similarities.Similarity类。这个类通过在硬盘的多个文件上分割索引，这些文件称为 shards，使用固定内存运行。它在内部使用similarities.MatrixSimilarity及similarities.SparseMatrixSimilarity，因此，仍然很快，尽管有点更加复杂。</p>

<p>索引的持久化通过标准的save()和load()函数处理：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">index</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;/tmp/deerwester.index&#39;</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">similarities</span><span class="o">.</span><span class="n">MatrixSimilarity</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;/tmp/deerwester.index&#39;</span><span class="p">)</span>
</code></pre></div>
<p>所有的索引类都是这样的（similarities.Similarity, similarities.MatrixSimilarity和similarities.SparseMatrixSimilarity)。接下来这些也是，索引可以是这类中的任何一个对象。如果不确定，使用similarities.Similarity，因为这是扩展性最好的版本，并且它还支持后续为索引添加更多的文档。</p>

<h1>进行查询</h1>

<p>获得查询文档对9个索引文档的相似性：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sims</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">vec_lsi</span><span class="p">]</span> <span class="c"># 进行语料的相似查询</span>
<span class="k">print</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">sims</span><span class="p">))</span> <span class="c"># 打印(document_number, document_similarity) 2-tuples</span>

<span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.99809301</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.93748635</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.99844527</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.9865886</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.90755945</span><span class="p">),</span>
<span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.12416792</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1063926</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.098794639</span><span class="p">),</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.05004178</span><span class="p">)]</span>
</code></pre></div>
<p>余弦度量返回的的相似性在&lt;-1,1&gt;之前（越大越相似），因此，第一个文档的总分为0.99809301。</p>

<p>使用类似的标准Python魔法，我们可以将相似性降序排列，获得“Human computer interaction”查询的最终答案:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sims</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">sims</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="o">-</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">print</span> <span class="n">sims</span> <span class="c"># 打印排序的 (document number, similarity score) 2-tuples</span>

<span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.99844527</span><span class="p">),</span> <span class="c"># The EPS user interface management system</span>
<span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.99809301</span><span class="p">),</span> <span class="c"># Human machine interface for lab abc computer applications</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.9865886</span><span class="p">),</span> <span class="c"># System and human system engineering testing of EPS</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.93748635</span><span class="p">),</span> <span class="c"># A survey of user opinion of computer system response time</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.90755945</span><span class="p">),</span> <span class="c"># Relation of user perceived response time to error measurement</span>
<span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.050041795</span><span class="p">),</span> <span class="c"># Graph minors A survey</span>
<span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.098794639</span><span class="p">),</span> <span class="c"># Graph minors IV Widths of trees and well quasi ordering</span>
<span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1063926</span><span class="p">),</span> <span class="c"># The intersection graph of paths in trees</span>
<span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.12416792</span><span class="p">)]</span> <span class="c"># The generation of random binary unordered trees</span>
</code></pre></div>
<p>（为了更清晰，我在输出中用评论添加了原始文档的”字符形式”。）</p>

<p>这里注意的是第二号（&quot;The EPS user interface management system&quot;)及第四号（&quot;Relation of user perceived response time to error measurement&quot;）文档永远也不会返回一个标准的布尔全文搜索，因为它们与&quot;Human computer interaction&quot;没有相同的词。但是，应用LSI后，我们可以看到他们获得了很高的相似性分数（二号实际上是最相似！），更好的反映了我们的直觉，他们与查询都是关于“计算机-人类”这个话题。事实上，这句语言概括也是首先应用主题建模的原因。</p>

<h1>接下来是什么？</h1>

<p>祝贺你，你完成了教程-现在你知道了gensim如何工作:-)要研究更多细节，你需要看一下<a href="http://radimrehurek.com/gensim/apiref.html">API文档</a>，查看<a href="http://radimrehurek.com/gensim/wiki.html">维基百科实验</a>或者看一下gensim中<a href="http://radimrehurek.com/gensim/distributed.html">分布计算</a>。</p>

<p>Gensim是相当成熟的包，被许多个人和公司成功应用，无论是快速原型还是在生产环境。
但是，这不意味这它是完美的：</p>

<ul>
<li><p>有许多部分应该更有效的实现（比如说用C），或者使用更好的并行机制（多核）</p></li>
<li><p>新算法层出不穷；通过<a href="http://groups.google.com/group/gensim">讨论</a>帮助gensim保持更新并且<a href="https://github.com/piskvorky/gensim/wiki/Developer-page">贡献代码</a></p></li>
<li><p>非常欢迎和感激你的反馈（不仅仅是代码！）：贡献思想、报告bug或者<a href="http://groups.google.com/group/gensim/topics">考虑共享用户故事和一般问题</a></p></li>
</ul>

<p>Gensim没有野心称为一个无所不包的框架，涉及所有NLP（甚至机器学习）的领域。它的使命是帮助NLP从业者轻松在大数据集上尝试流行主题建模算法，并且帮助研究者设计算法原型。</p>

<p><a href="http://radimrehurek.com/gensim/tut3.html">原文地址</a></p>

    </div>

    
      <ul class="tag_box inline">
        <li><i class="icon-folder-open"></i></li>
        
        


  
     
    	<li><a href="/categories.html#python-ref">
    		python <span>17</span>
    	</a></li>
    
  


      </ul>
    

    
      <ul class="tag_box inline">
        <li><i class="icon-tags"></i></li>
        
        


  
     
    	<li><a href="/tags.html#Python-ref">Python <span>17</span></a></li>
     
    	<li><a href="/tags.html#gensim-ref">gensim <span>3</span></a></li>
    
  



      </ul>
    

    <hr>
    
    <ul class="pagination">
      
        <li class="prev"><a href="/python/2014/01/27/Gensim_Topics_and_Transformations" title="gensim文档-主题与转换">&larr; 上一页</a></li>
      
        <li><a href="/archive.html">归档列表</a></li>
      
        <li class="next"><a href="/python/2014/02/01/classification_with_organce" title="分类-Orange教程">下一页 &rarr;</a></li>
      
    </ul>
    <hr>
    <!-- Paste the 3 next lines where you want the sharing button(s) to appear -->
    <div class="post-sharing">
     


  <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
	<span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tools_1"></a>
	<a class="jiathis_button_tools_2"></a>
	<a class="jiathis_button_tools_3"></a>
	<a class="jiathis_button_tools_4"></a>
	<a href="http://www.jiathis.com/share?uid=1654363" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1343300786690926" charset="utf-8"></script>
<!-- JiaThis Button END -->



    </div>    
    <div class="post-comments">
    


  <!-- UJian Button BEGIN -->
<div class="ujian-hook"></div>
<script type="text/javascript">var ujian_config = {num:12,picSize:84,textHeight:45};</script>
<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?uid=1654363"></script>
<a href="http://www.ujian.cc" style="border:0;"><img src="http://img.ujian.cc/pixel.png" alt="友荐云推荐" style="border:0;padding:0;margin:0;" /></a>
<!-- UJian Button END -->
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1654363"></script>
<!-- UY END -->



    </div>
  </div>
</div>


      <hr>
      <footer>
        <p>
          &copy; 2014 Cloga Chen
          <span class="pull-right text-muted">
            powered by
            <a href="http://jekyll-bootstrap-3.github.io" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll-Bootstrap-3</a>
            and <a href="http://getbootstrap.com" target="_blank">Twitter Bootstrap 3.0.3</a>
          </span>
        </p>
      </footer>
    </div>

    
    <script src="/assets/themes/bootstrap/resources/jquery/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap/resources/bootstrap/js/bootstrap.min.js"></script>
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-7VF4"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-7VF4');</script>
<!-- End Google Tag Manager -->


  </body>
</html>

